<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æˆ‘çš„ä¸­çç´€éŒ„</title>
<style>
  body{margin:0;background:#111;color:#fff;font-family:"Microsoft JhengHei";padding:14px}
  h2{color:#ffd700;text-align:center;margin-bottom:20px}
  .loading{text-align:center;color:#ffc107;margin:20px 0}
  .error{text-align:center;color:#ff6b6b;margin:20px 0}
  .card{background:#333;border-radius:10px;padding:14px;margin-bottom:12px;box-shadow:0 4px 8px rgba(0,0,0,.2);color:#ddd}
  .card h3{margin:4px 0 8px;font-size:1.1em;color:#eee;border-bottom:1px solid #555;padding-bottom:8px}
  .info-item{display:flex;justify-content:space-between;margin-bottom:6px;font-size:.95em}
  .info-label{font-weight:bold;color:#ccc;margin-right:10px;flex-shrink:0}
  .info-content{text-align:right;flex-grow:1}
  .redeemBtn{margin-top:15px;width:100%;padding:12px;border:none;border-radius:8px;background:#ffc107;color:#000;font-size:1em;cursor:pointer;transition:background .3s}
  .redeemBtn:hover:not(:disabled){background:#e0a800}
  .redeemBtn.done{background:#666;color:#bbb;cursor:not-allowed}
  .redeemBtn:disabled{opacity:0.7}
  p{text-align:center;color:#aaa;margin-top:20px}
  .refresh-btn{
    position:fixed;
    bottom:20px;
    right:20px;
    background:#28a745;
    color:#fff;
    border:none;
    border-radius:50%;
    width:50px;
    height:50px;
    font-size:1.2em;
    cursor:pointer;
    box-shadow:0 2px 10px rgba(0,0,0,.3);
    z-index:1000;
  }
  .refresh-btn:hover{background:#218838}
  .back-btn{
    position:fixed;
    top:20px;
    left:20px;
    background:#007bff;
    color:#fff;
    border:none;
    border-radius:20px;
    padding:8px 16px;
    font-size:0.9em;
    cursor:pointer;
    z-index:1000;
  }
  .back-btn:hover{background:#0056b3}
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<button class="back-btn" onclick="goBack()">â† è¿”å›éŠæˆ²</button>
<h2>ğŸ æˆ‘çš„ä¸­çç´€éŒ„</h2>
<div id="list"><div class="loading">è¼‰å…¥ä¸­...</div></div>
<button class="refresh-btn" onclick="loadRecords()" title="é‡æ–°è¼‰å…¥">ğŸ”„</button>

<script>
const LIFF_ID = "1656871455-vE1ZZLJ7";
const API = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; // è«‹æ›¿æ›æˆæ‚¨çš„ Apps Script éƒ¨ç½²ç¶²å€

let currentUserId = '';

/* ---------- æ”¹é€²çš„ API è«‹æ±‚å‡½å¼ ---------- */
async function apiRequest(data) {
  try {
    // ä½¿ç”¨ fetch ä¸¦æ­£ç¢ºè™•ç† CORS
    const response = await fetch(API, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
      mode: "cors"  // æ˜ç¢ºæŒ‡å®š CORS æ¨¡å¼
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ä¼ºæœå™¨éŒ¯èª¤`);
    }
    
    const result = await response.json();
    
    if (result.status === 'err') {
      throw new Error(result.message || 'ä¼ºæœå™¨éŒ¯èª¤');
    }
    
    return result.data;
  } catch (error) {
    console.error('API è«‹æ±‚å¤±æ•—:', error);
    
    // å¦‚æœæ˜¯ CORS æˆ–ç¶²è·¯éŒ¯èª¤ï¼Œæä¾›æ›´å‹å–„çš„éŒ¯èª¤è¨Šæ¯
    if (error.name === 'TypeError' || error.message.includes('CORS')) {
      throw new Error('ç¶²è·¯é€£ç·šå•é¡Œï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹');
    }
    
    throw error;
  }
}

/* ---------- åˆå§‹åŒ– ---------- */
(async () => {
  try {
    await liff.init({ liffId: LIFF_ID });
    
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    
    const profile = await liff.getProfile();
    currentUserId = profile.userId;
    
    await loadRecords();
    
  } catch (error) {
    console.error('åˆå§‹åŒ–å¤±æ•—:', error);
    showError('è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
  }
})();

/* ---------- è¼‰å…¥ç´€éŒ„ ---------- */
async function loadRecords() {
  if (!currentUserId) {
    showError('ä½¿ç”¨è€…è³‡è¨Šæœªè¼‰å…¥');
    return;
  }
  
  try {
    showLoading();
    
    const records = await apiRequest({
      act: 'query',
      userId: currentUserId
    });
    
    renderRecords(records);
    
  } catch (error) {
    console.error('è¼‰å…¥ç´€éŒ„å¤±æ•—:', error);
    showError('è¼‰å…¥ç´€éŒ„å¤±æ•—: ' + error.message);
  }
}

/* ---------- é¡¯ç¤ºç‹€æ…‹ ---------- */
function showLoading() {
  document.getElementById('list').innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
}

function showError(message) {
  document.getElementById('list').innerHTML = `<div class="error">âŒ ${message}<br><button onclick="loadRecords()" style="margin-top:10px;padding:8px 16px;background:#ffc107;border:none;border-radius:5px;cursor:pointer;">é‡è©¦</button></div>`;
}

/* ---------- æ¸²æŸ“ç´€éŒ„ ---------- */
function renderRecords(records) {
  const listElement = document.getElementById('list');
  
  if (!records || records.length === 0) {
    listElement.innerHTML = '<p>å°šç„¡ä¸­çç´€éŒ„</p>';
    return;
  }
  
  listElement.innerHTML = records.map(record => `
    <div class="card" id="card${record.row}">
      <h3>${escapeHtml(record.lineName)}</h3>
      <div class="info">
        <div class="info-item">
          <span class="info-label">ä¸­çæ™‚é–“:</span>
          <span class="info-content">${formatDateTime(record.winTime)}</span>
        </div>
        <div class="info-item">
          <span class="info-label">éŠæˆ²åç¨±:</span>
          <span class="info-content">${escapeHtml(record.game)}</span>
        </div>
        <div class="info-item">
          <span class="info-label">å„ªæƒ å…§å®¹:</span>
          <span class="info-content">${escapeHtml(record.prize)}</span>
        </div>
      </div>
      ${record.isRedeem ? 
        `<button class="redeemBtn done" disabled>å·²æ ¸éŠ·<br>${formatDateTime(record.redeemTime)}</button>` :
        `<button class="redeemBtn" onclick="redeem(${record.row}, this)">æ ¸éŠ·</button>`
      }
    </div>
  `).join('');
}

/* ---------- æ ¸éŠ·åŠŸèƒ½ ---------- */
async function redeem(row, button) {
  if (!row || !button) {
    alert('ç³»çµ±éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
    return;
  }
  
  if (!confirm('ç¢ºå®šè¦æ ¸éŠ·æ­¤å„ªæƒ åˆ¸å—ï¼Ÿæ ¸éŠ·å¾Œç„¡æ³•å¾©åŸã€‚')) {
    return;
  }
  
  button.disabled = true;
  button.textContent = "è™•ç†ä¸­â€¦";
  button.style.background = "#555";
  
  try {
    const result = await apiRequest({
      act: 'redeem',
      row: row
    });
    
    button.className = "redeemBtn done";
    button.innerHTML = `å·²æ ¸éŠ·<br>${formatDateTime(result)}`;
    
    showToast('æ ¸éŠ·æˆåŠŸï¼');
    
  } catch (error) {
    console.error('æ ¸éŠ·å¤±æ•—:', error);
    
    button.disabled = false;
    button.textContent = "æ ¸éŠ·";
    button.style.background = "#ffc107";
    
    alert("æ ¸éŠ·å¤±æ•—ï¼š" + error.message);
  }
}

/* ---------- è¿”å›éŠæˆ² ---------- */
function goBack() {
  // å¦‚æœæ˜¯åœ¨ LINE ä¸­ï¼Œå¯ä»¥å°èˆªåˆ°éŠæˆ²é é¢
  if (liff.isInClient()) {
    // å‡è¨­æ‚¨çš„éŠæˆ²é é¢æ˜¯ index.html
    window.location.href = 'index.html';
  } else {
    // åœ¨ç€è¦½å™¨ä¸­ï¼Œä½¿ç”¨ history.back()
    window.history.back();
  }
}

/* ---------- å·¥å…·å‡½å¼ ---------- */
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatDateTime(dateTime) {
  if (!dateTime) return '';
  
  try {
    const date = new Date(dateTime);
    if (isNaN(date.getTime())) return dateTime;
    
    return date.toLocaleString('zh-TW', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
  } catch (error) {
    return dateTime;
  }
}

function showToast(message) {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #28a745;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    z-index: 1001;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    if (toast.parentNode) {
      toast.parentNode.removeChild(toast);
    }
  }, 3000);
}

/* ---------- éŒ¯èª¤è™•ç† ---------- */
window.addEventListener('error', (event) => {
  console.error('å…¨åŸŸéŒ¯èª¤:', event.error);
});

window.addEventListener('unhandledrejection', (event) => {
  console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', event.reason);
});
</script>
</body>
</html>
