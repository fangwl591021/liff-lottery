<!DOCTYPE html>
<html lang="zh-Hant">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
Â  <title>LINE æŠ½ç</title>
Â  <style>
Â  Â  html, body {
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  Â  background: #000;
Â  Â  Â  color: #fff;
Â  Â  Â  font-family: "Microsoft JhengHei", sans-serif;
Â  Â  Â  height: 100vh;
Â  Â  Â  overflow: hidden;
Â  Â  Â  display: flex; /* ä½¿ç”¨ Flexbox è®“å…§å®¹å‚ç›´ç½®ä¸­ */
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  }
Â  Â  .app {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  align-items: center;
Â  Â  Â  height: 100%;
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 20px;
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  max-width: 500px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œé¿å…åœ¨å¯¬è¢å¹•ä¸Šå¤ªåˆ†æ•£ */
Â  Â  Â  text-align: center; /* æ–‡å­—ç½®ä¸­ */
Â  Â  }
Â  Â  h1 {
Â  Â  Â  font-size: 2rem;
Â  Â  Â  margin: 30px 0 20px 0;
Â  Â  Â  text-align: center;
Â  Â  Â  color: gold;
Â  Â  }
Â  Â  button {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 50px;
Â  Â  Â  margin-top: 30px;
Â  Â  Â  font-size: 2.2rem;
Â  Â  Â  background: #28a745;
Â  Â  Â  color: #fff;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: background-color 0.3s ease;
Â  Â  }
Â  Â  button:hover:not(:disabled) {
Â  Â  Â  background-color: #218838;
Â  Â  }
Â  Â  button:disabled {
Â  Â  Â  background-color: #555 !important;
Â  Â  Â  color: #ccc !important;
Â  Â  Â  cursor: not-allowed;
Â  Â  }
Â  Â  #form {
Â  Â  Â  display: none;
Â  Â  Â  width: 100%;
Â  Â  Â  margin-top: 30px;
Â  Â  }
Â  Â  #form h3 {
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  color: #fff;
Â  Â  }
Â  Â  input {
Â  Â  Â  width: calc(100% - 60px);
Â  Â  Â  padding: 30px;
Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  margin-top: 20px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  border: none;
Â  Â  Â  box-sizing: border-box;
Â  Â  }
Â  Â  #drawVideo {
Â  Â  Â  display: none;
Â  Â  Â  width: 100%;
Â  Â  Â  max-width: 400px;
Â  Â  Â  margin-top: 30px;
Â  Â  Â  border-radius: 12px;
Â  Â  }
Â  Â  #result {
Â  Â  Â  font-size: 2rem;
Â  Â  Â  margin-top: 30px;
Â  Â  Â  color: yellow;
Â  Â  Â  display: none;
Â  Â  Â  font-weight: bold;
Â  Â  }
Â  </style>
</head>
<body>
Â  <div class="app">
Â  Â  <h1>ğŸ‰ LINE æŠ½ç ğŸ‰</h1>
Â  Â  <button id="startGameBtn" disabled>è¼‰å…¥ä¸­...</button>

Â  Â  <video id="drawVideo" playsinline muted>
Â  Â  Â  <source src="https://voom-obs.line-scdn.net/hlCRdDEcYL206cTxjDScoFBNJJEIQdnV_LAIXSjV7EgYpVB9hLCd0ChpvBhcjSzV8LDMXCyt7DQAXSHVzAw0bTyF7K18pSBQ7ADAMTDFBN1Q-XQ/mp4" type="video/mp4">
Â  Â  Â  æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒå½±ç‰‡æ¨™ç±¤ã€‚
Â  Â  </video>

Â  Â  <div id="result"></div>

Â  Â  <div id="form">
Â  Â  Â  <h3>æ­å–œä¸­çï¼è«‹å¡«å¯«ä»¥ä¸‹è³‡æ–™</h3>
Â  Â  Â  <input type="text" id="winnerName" placeholder="è¼¸å…¥æ‚¨çš„å§“å" />
Â  Â  Â  <input type="tel" id="winnerPhone" placeholder="è¼¸å…¥æ‚¨çš„é›»è©±" />
Â  Â  Â  <button id="submitBtn">é€å‡ºä¸­çè³‡æ–™</button>
Â  Â  </div>
Â  </div>

Â  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
Â  <script>
Â  Â  const liffId = "1656871455-vE1ZZLJ7"; // æ‚¨çš„ LIFF ID
Â  Â  // æ‚¨çš„ Apps Script éƒ¨ç½² URLï¼Œé€™æ˜¯å¾Œç«¯çš„ API ç¶²å€
Â  Â  const appsScriptUrl = "https://script.google.com/macros/s/AKfycbyl0kPNcBS6zOlcqL-2E4LkVdK_SDpEudi-gtRzNDakNMI3e_qoOoEMg4UJsKtHJwgR/exec"; // <-- ç¢ºä¿é€™è£¡æ˜¯æ‚¨æ­£ç¢ºçš„ Apps Script URL

Â  Â  let userId = "";
Â  Â  let displayName = "";

Â  Â  const startGameBtn = document.getElementById("startGameBtn");
Â  Â  const drawVideo = document.getElementById("drawVideo");
Â  Â  const resultDiv = document.getElementById("result");
Â  Â  const formDiv = document.getElementById("form");
Â  Â  const winnerNameInput = document.getElementById("winnerName");
Â  Â  const winnerPhoneInput = document.getElementById("winnerPhone");
Â  Â  const submitBtn = document.getElementById("submitBtn");

Â  Â  async function callAppsScript(action, params = {}) {
Â  Â  Â  // å°‡ action åŠ å…¥åƒæ•¸ä¸­
Â  Â  Â  const urlParams = new URLSearchParams({ ...params, action: action }).toString();
Â  Â  Â  const url = `${appsScriptUrl}?${urlParams}`;

Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(url, { method: 'GET', mode: 'cors' });
Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  throw new Error(`HTTP error! status: ${response.status}`);
Â  Â  Â  Â  }
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  if (data.status === 'error') {
Â  Â  Â  Â  Â  throw new Error(data.message || 'Apps Script returned an error.');
Â  Â  Â  Â  }
Â  Â  Â  Â  return data.data; // è¿”å› Apps Script è¿”å›çš„å¯¦éš›æ•¸æ“š
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Call Apps Script Error:", error);
Â  Â  Â  Â  throw error; // é‡æ–°æ‹‹å‡ºéŒ¯èª¤ä»¥ä¾¿ä¸Šå±¤æ•ç²
Â  Â  Â  }
Â  Â  }

Â  Â  async function main() {
Â  Â  Â  try {
Â  Â  Â  Â  await liff.init({ liffId });

Â  Â  Â  Â  if (!liff.isLoggedIn()) {
Â  Â  Â  Â  Â  liff.login();
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const profile = await liff.getProfile();
Â  Â  Â  Â  userId = profile.userId;
Â  Â  Â  Â  displayName = profile.displayName;
Â  Â  Â  Â  console.log("LIFF ç™»å…¥å®Œæˆï¼š", userId, displayName);

Â  Â  Â  Â  checkAndSetButtonState();

Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error("LIFF åˆå§‹åŒ–å¤±æ•—æˆ–ç²å–è³‡æ–™éŒ¯èª¤", err);
Â  Â  Â  Â  startGameBtn.textContent = "è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦";
Â  Â  Â  Â  startGameBtn.disabled = true;
Â  Â  Â  Â  alert("é é¢è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚");
Â  Â  Â  }
Â  Â  }

Â  Â  async function checkAndSetButtonState() {
Â  Â  Â  if (!userId) {
Â  Â  Â  Â  console.warn("UserId å°šæœªè¼‰å…¥ï¼Œç¨å¾Œé‡è©¦æŒ‰éˆ•ç‹€æ…‹æª¢æŸ¥...");
Â  Â  Â  Â  setTimeout(checkAndSetButtonState, 500);
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  try {
Â  Â  Â  Â  const count = await callAppsScript('checkDrawQuota', { userId: userId });
Â  Â  Â  Â  console.log("ä»Šå¤©å·²æŠ½çæ¬¡æ•¸ï¼š", count);
Â  Â  Â  Â  if (count >= 3) {
Â  Â  Â  Â  Â  startGameBtn.disabled = true;
Â  Â  Â  Â  Â  startGameBtn.textContent = "ä»Šæ—¥æŠ½çæ¬¡æ•¸å·²ç”¨å®Œï¼";
Â  Â  Â  Â  Â  resultDiv.textContent = "ä»Šæ—¥æŠ½çæ¬¡æ•¸å·²ç”¨å®Œï¼Œè«‹æ˜å¤©å†ä¾†ï¼";
Â  Â  Â  Â  Â  resultDiv.style.display = "block";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  startGameBtn.disabled = false;
Â  Â  Â  Â  Â  startGameBtn.textContent = "é»æˆ‘é–‹å§‹æŠ½ç";
Â  Â  Â  Â  Â  resultDiv.style.display = "none";
Â  Â  Â  Â  Â  formDiv.style.display = "none";
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("æª¢æŸ¥æŠ½çé…é¡å¤±æ•—:", error);
Â  Â  Â  Â  startGameBtn.disabled = true;
Â  Â  Â  Â  startGameBtn.textContent = "ç„¡æ³•æª¢æŸ¥é…é¡ï¼Œè«‹é‡è©¦";
Â  Â  Â  Â  alert("ç„¡æ³•æª¢æŸ¥æ‚¨çš„æŠ½çæ¬¡æ•¸ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
Â  Â  Â  }
Â  Â  }

Â  Â  startGameBtn.addEventListener("click", async () => {
Â  Â  Â  if (!userId) {
Â  Â  Â  Â  alert("LIFF è³‡è¨Šå°šæœªè¼‰å…¥ï¼Œè«‹ç¨å€™å†è©¦ã€‚");
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  try {
Â  Â  Â  Â  const count = await callAppsScript('checkDrawQuota', { userId: userId });
Â  Â  Â  Â  if (count >= 3) {
Â  Â  Â  Â  Â  alert("æ‚¨ä»Šå¤©å·²ç¶“æŠ½çä¸‰æ¬¡ï¼Œè«‹æ˜å¤©å†ä¾†ï¼");
Â  Â  Â  Â  Â  checkAndSetButtonState();
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  startGameBtn.disabled = true;
Â  Â  Â  Â  startGameBtn.style.display = "none";
Â  Â  Â  Â  resultDiv.style.display = "none";
Â  Â  Â  Â  formDiv.style.display = "none";

Â  Â  Â  Â  drawVideo.style.display = "block";
Â  Â  Â  Â  drawVideo.currentTime = 0;
Â  Â  Â  Â  drawVideo.play().catch(err => {
Â  Â  Â  Â  Â  console.error("å½±ç‰‡æ’­æ”¾å¤±æ•—:", err);
Â  Â  Â  Â  Â  alert("å½±ç‰‡æ’­æ”¾å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
Â  Â  Â  Â  Â  // å¦‚æœå½±ç‰‡æ’­æ”¾å¤±æ•—ï¼Œå›é€€æŒ‰éˆ•ç‹€æ…‹
Â  Â  Â  Â  Â  startGameBtn.style.display = "block";
Â  Â  Â  Â  Â  startGameBtn.disabled = false;
Â  Â  Â  Â  Â  startGameBtn.textContent = "é»æˆ‘é–‹å§‹æŠ½ç";
Â  Â  Â  Â  });

Â  Â  Â  Â  drawVideo.onended = async () => {
Â  Â  Â  Â  Â  drawVideo.style.display = "none";
Â  Â  Â  Â  Â  drawVideo.onended = null;

Â  Â  Â  Â  Â  const win = Math.random() < 0.5;
Â  Â  Â  Â  Â  const drawResultText = win ? "ä¸­ç" : "éŠ˜è¬æƒ é¡§";

Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await callAppsScript('recordDraw', { userId: userId, displayName: displayName, drawResult: drawResultText });
Â  Â  Â  Â  Â  } catch (recordErr) {
Â  Â  Â  Â  Â  Â  console.error("è¨˜éŒ„æŠ½çå¤±æ•—:", recordErr);
Â  Â  Â  Â  Â  Â  // å³ä½¿è¨˜éŒ„å¤±æ•—ä¹Ÿç¹¼çºŒæµç¨‹ï¼Œä½†å¯èƒ½æœƒå½±éŸ¿æ¬¡æ•¸çµ±è¨ˆ
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  if (win) {
Â  Â  Â  Â  Â  Â  resultDiv.textContent = "ğŸŠ æ­å–œä¸­çï¼";
Â  Â  Â  Â  Â  Â  formDiv.style.display = "block";
Â  Â  Â  Â  Â  Â  winnerNameInput.value = displayName;
Â  Â  Â  Â  Â  Â  winnerPhoneInput.value = '';
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  resultDiv.textContent = "ğŸ˜­ éŠ˜è¬æƒ é¡§ï¼Œå†æ¥å†å²ï¼";
Â  Â  Â  Â  Â  Â  checkAndSetButtonState();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  resultDiv.style.display = "block";
Â  Â  Â  Â  };
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("é–‹å§‹æŠ½çæ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
Â  Â  Â  Â  alert("ç„¡æ³•é–‹å§‹æŠ½çï¼Œè«‹ç¨å¾Œå†è©¦ã€‚" + error.message);
Â  Â  Â  Â  startGameBtn.style.display = "block";
Â  Â  Â  Â  startGameBtn.disabled = true;
Â  Â  Â  Â  startGameBtn.textContent = "æŠ½çå¤±æ•—ï¼Œè«‹é‡è©¦";
Â  Â  Â  Â  checkAndSetButtonState();
Â  Â  Â  }
Â  Â  });

Â  Â  submitBtn.addEventListener("click", async () => {
Â  Â  Â  const name = winnerNameInput.value.trim();
Â  Â  Â  const phone = winnerPhoneInput.value.trim();

Â  Â  Â  if (!name || !phone) {
Â  Â  Â  Â  alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™ (å§“åèˆ‡é›»è©±)");
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  submitBtn.disabled = true;
Â  Â  Â  submitBtn.style.backgroundColor = "#555";
Â  Â  Â  submitBtn.textContent = "é€å‡ºä¸­...";

Â  Â  Â  try {
Â  Â  Â  Â  await callAppsScript('recordWinner', {
Â  Â  Â  Â  Â  userId: userId,
Â  Â  Â  Â  Â  displayName: displayName,
Â  Â  Â  Â  Â  game: "æ‰‹æ©ŸæŠ½ç",
Â  Â  Â  Â  Â  prize: "æ¸¬è©¦çé …",
Â  Â  Â  Â  Â  name: name,
Â  Â  Â  Â  Â  phone: phone
Â  Â  Â  Â  });
Â  Â  Â  Â  alert("âœ… å·²é€å‡ºä¸­çè³‡æ–™ï¼");
Â  Â  Â  Â  liff.closeWindow();
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error("é€å‡ºä¸­çè³‡æ–™å¤±æ•—:", err);
Â  Â  Â  Â  alert("é€å‡ºå¤±æ•—ï¼š" + err.message + "\nè«‹æª¢æŸ¥ Apps Script åŸ·è¡Œæ—¥èªŒä»¥ç²å–æ›´å¤šè³‡è¨Šã€‚");
Â  Â  Â  Â  submitBtn.disabled = false;
Â  Â  Â  Â  submitBtn.style.backgroundColor = "#28a745";
Â  Â  Â  Â  submitBtn.textContent = "é‡æ–°é€å‡º";
Â  Â  Â  }
Â  Â  });

Â  Â  main();
Â  </script>
</body>
</html>
