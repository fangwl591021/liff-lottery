<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>LINE 抽獎</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      color: #fff;
      font-family: "Microsoft JhengHei", sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex; /* 使用 Flexbox 讓內容垂直置中 */
      align-items: center;
      justify-content: center;
    }
    .app {
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
      width: 100%;
      padding: 20px;
      box-sizing: border-box;
      max-width: 500px; /* 限制最大寬度，避免在寬螢幕上太分散 */
      text-align: center; /* 文字置中 */
    }
    h1 {
      font-size: 2rem;
      margin: 30px 0 20px 0;
      text-align: center;
      color: gold;
    }
    button {
      width: 100%;
      padding: 50px;
      margin-top: 30px;
      font-size: 2.2rem;
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover:not(:disabled) {
      background-color: #218838;
    }
    button:disabled {
      background-color: #555 !important;
      color: #ccc !important;
      cursor: not-allowed;
    }
    #form {
      display: none;
      width: 100%;
      margin-top: 30px;
    }
    #form h3 {
      margin-bottom: 20px;
      font-size: 1.5rem;
      color: #fff;
    }
    input {
      width: calc(100% - 60px);
      padding: 30px;
      font-size: 1.5rem;
      margin-top: 20px;
      border-radius: 8px;
      border: none;
      box-sizing: border-box;
    }
    #drawVideo {
      display: none;
      width: 100%;
      max-width: 400px;
      margin-top: 30px;
      border-radius: 12px;
    }
    #result {
      font-size: 2rem;
      margin-top: 30px;
      color: yellow;
      display: none;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>🎉 LINE 抽獎 🎉</h1>
    <button id="startGameBtn" disabled>載入中...</button>

    <video id="drawVideo" playsinline muted>
      <source src="https://voom-obs.line-scdn.net/hlCRdDEcYL206cTxjDScoFBNJJEIQdnV_LAIXSjV7EgYpVB9hLCd0ChpvBhcjSzV8LDMXCyt7DQAXSHVzAw0bTyF7K18pSBQ7ADAMTDFBN1Q-XQ/mp4" type="video/mp4">
      您的瀏覽器不支持影片標籤。
    </video>

    <div id="result"></div>

    <div id="form">
      <h3>恭喜中獎！請填寫以下資料</h3>
      <input type="text" id="winnerName" placeholder="輸入您的姓名" />
      <input type="tel" id="winnerPhone" placeholder="輸入您的電話" />
      <button id="submitBtn">送出中獎資料</button>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const liffId = "1656871455-vE1ZZLJ7"; // 您的 LIFF ID
    // 您的 Apps Script 部署 URL，這是後端的 API 網址
    const appsScriptUrl = "https://script.google.com/macros/s/AKfycbyl0kPNcBS6zOlcqL-2E4LkVdK_SDpEudi-gtRzNDakNMI3e_qoOoEMg4UJsKtHJwgR/exec"; // <-- 確保這裡是您正確的 Apps Script URL

    let userId = "";
    let displayName = "";

    const startGameBtn = document.getElementById("startGameBtn");
    const drawVideo = document.getElementById("drawVideo");
    const resultDiv = document.getElementById("result");
    const formDiv = document.getElementById("form");
    const winnerNameInput = document.getElementById("winnerName");
    const winnerPhoneInput = document.getElementById("winnerPhone");
    const submitBtn = document.getElementById("submitBtn");

    async function callAppsScript(action, params = {}) {
      // 將 action 加入參數中
      const urlParams = new URLSearchParams({ ...params, action: action }).toString();
      const url = `${appsScriptUrl}?${urlParams}`;

      try {
        const response = await fetch(url, { method: 'GET', mode: 'cors' });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        if (data.status === 'error') {
          throw new Error(data.message || 'Apps Script returned an error.');
        }
        return data.data; // 返回 Apps Script 返回的實際數據
      } catch (error) {
        console.error("Call Apps Script Error:", error);
        throw error; // 重新拋出錯誤以便上層捕獲
      }
    }

    async function main() {
      try {
        await liff.init({ liffId });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        userId = profile.userId;
        displayName = profile.displayName;
        console.log("LIFF 登入完成：", userId, displayName);

        checkAndSetButtonState();

      } catch (err) {
        console.error("LIFF 初始化失敗或獲取資料錯誤", err);
        startGameBtn.textContent = "載入失敗，請重試";
        startGameBtn.disabled = true;
        alert("頁面載入失敗，請檢查網路或稍後再試。");
      }
    }

    async function checkAndSetButtonState() {
      if (!userId) {
        console.warn("UserId 尚未載入，稍後重試按鈕狀態檢查...");
        setTimeout(checkAndSetButtonState, 500);
        return;
      }

      try {
        const count = await callAppsScript('checkDrawQuota', { userId: userId });
        console.log("今天已抽獎次數：", count);
        if (count >= 3) {
          startGameBtn.disabled = true;
          startGameBtn.textContent = "今日抽獎次數已用完！";
          resultDiv.textContent = "今日抽獎次數已用完，請明天再來！";
          resultDiv.style.display = "block";
        } else {
          startGameBtn.disabled = false;
          startGameBtn.textContent = "點我開始抽獎";
          resultDiv.style.display = "none";
          formDiv.style.display = "none";
        }
      } catch (error) {
        console.error("檢查抽獎配額失敗:", error);
        startGameBtn.disabled = true;
        startGameBtn.textContent = "無法檢查配額，請重試";
        alert("無法檢查您的抽獎次數，請稍後再試。");
      }
    }

    startGameBtn.addEventListener("click", async () => {
      if (!userId) {
        alert("LIFF 資訊尚未載入，請稍候再試。");
        return;
      }

      try {
        const count = await callAppsScript('checkDrawQuota', { userId: userId });
        if (count >= 3) {
          alert("您今天已經抽獎三次，請明天再來！");
          checkAndSetButtonState();
          return;
        }

        startGameBtn.disabled = true;
        startGameBtn.style.display = "none";
        resultDiv.style.display = "none";
        formDiv.style.display = "none";

        drawVideo.style.display = "block";
        drawVideo.currentTime = 0;
        drawVideo.play().catch(err => {
          console.error("影片播放失敗:", err);
          alert("影片播放失敗，請檢查網路。");
          // 如果影片播放失敗，回退按鈕狀態
          startGameBtn.style.display = "block";
          startGameBtn.disabled = false;
          startGameBtn.textContent = "點我開始抽獎";
        });

        drawVideo.onended = async () => {
          drawVideo.style.display = "none";
          drawVideo.onended = null;

          const win = Math.random() < 0.5;
          const drawResultText = win ? "中獎" : "銘謝惠顧";

          try {
            await callAppsScript('recordDraw', { userId: userId, displayName: displayName, drawResult: drawResultText });
          } catch (recordErr) {
            console.error("記錄抽獎失敗:", recordErr);
            // 即使記錄失敗也繼續流程，但可能會影響次數統計
          }

          if (win) {
            resultDiv.textContent = "🎊 恭喜中獎！";
            formDiv.style.display = "block";
            winnerNameInput.value = displayName;
            winnerPhoneInput.value = '';
          } else {
            resultDiv.textContent = "😭 銘謝惠顧，再接再厲！";
            checkAndSetButtonState();
          }
          resultDiv.style.display = "block";
        };
      } catch (error) {
        console.error("開始抽獎時發生錯誤:", error);
        alert("無法開始抽獎，請稍後再試。" + error.message);
        startGameBtn.style.display = "block";
        startGameBtn.disabled = true;
        startGameBtn.textContent = "抽獎失敗，請重試";
        checkAndSetButtonState();
      }
    });

    submitBtn.addEventListener("click", async () => {
      const name = winnerNameInput.value.trim();
      const phone = winnerPhoneInput.value.trim();

      if (!name || !phone) {
        alert("請輸入完整資料 (姓名與電話)");
        return;
      }

      submitBtn.disabled = true;
      submitBtn.style.backgroundColor = "#555";
      submitBtn.textContent = "送出中...";

      try {
        await callAppsScript('recordWinner', {
          userId: userId,
          displayName: displayName,
          game: "手機抽獎",
          prize: "測試獎項",
          name: name,
          phone: phone
        });
        alert("✅ 已送出中獎資料！");
        liff.closeWindow();
      } catch (err) {
        console.error("送出中獎資料失敗:", err);
        alert("送出失敗：" + err.message + "\n請檢查 Apps Script 執行日誌以獲取更多資訊。");
        submitBtn.disabled = false;
        submitBtn.style.backgroundColor = "#28a745";
        submitBtn.textContent = "重新送出";
      }
    });

    main();
  </script>
</body>
</html>
