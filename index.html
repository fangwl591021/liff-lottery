const SHEET_ID = '1IhVlMOpwdk66R7a1sFfyqUzJWcHyZrUNKR09BxdFkFY';
const PRIZE_SHEET = '中獎紀錄表';
const DRAW_SHEET = '抽獎紀錄表';

function doGet() {
  return HtmlService.createHtmlOutputFromFile('index');
}

// 記錄中獎
function recordWinner(data) {
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(PRIZE_SHEET);
  sheet.appendRow([
    data.userId || '',
    data.displayName || '',
    data.game || '',
    data.prize || '',
    data.name || '',
    data.phone || '',
    new Date(), // 中獎時間
    Utilities.formatDate(new Date(), "Asia/Taipei", "yyyy-MM-dd"), // 抽獎日期
    '', // 是否核銷
    '', // 核銷時間
    '', // 店家名稱
    ''  // 店家備註
  ]);
  return 'OK';
}

// 記錄抽獎
function recordDraw(userId, displayName) {
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(DRAW_SHEET);
  sheet.appendRow([
    userId,
    Utilities.formatDate(new Date(), "Asia/Taipei", "yyyy-MM-dd HH:mm:ss")
  ]);
  return 'OK';
}


// 檢查當日已抽次數
function checkDrawQuota(userId) {
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(DRAW_SHEET);
  const today = Utilities.formatDate(new Date(), "Asia/Taipei", "yyyy-MM-dd");
  const data = sheet.getDataRange().getValues();
  
  let count = 0;
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === userId && data[i][2].startsWith(today)) {
      count++;
    }
  }
  return count;
}
